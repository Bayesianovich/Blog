<article class="post-detail">
  <!-- Left Floating TOC -->
  <% if (page.content && toc(page.content)) { %>
    <div class="left-toc-container">
      <div class="toc-title"><i class="fas fa-list-ul"></i> 目录</div>
      <div class="toc-content">
        <%- toc(page.content, {list_number: false}) %>
      </div>
    </div>
    <style>
      .left-toc-container {
        position: fixed;
        left: calc((100vw - 1200px) / 2 - 240px); /* 动态计算位置：居中容器左侧 */
        top: 100px;
        width: 220px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        z-index: 99;
        padding: 10px;
        font-size: 13px;
        transition: opacity 0.3s;
        opacity: 0.6; /* 默认半透明，避免干扰 */
      }
      
      .left-toc-container:hover {
        opacity: 1;
      }

      /* 当屏幕不够宽时隐藏 */
      @media (max-width: 1450px) {
        .left-toc-container {
          display: none;
        }
      }
      
      .left-toc-container .toc-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--text-title);
        font-size: 14px;
        padding-left: 10px;
      }

      .left-toc-container ol {
        padding-left: 10px; /* 减少缩进 */
        margin: 0;
        list-style: none;
        position: relative;
      }
      
      /* 添加左侧线条 */
      .left-toc-container .toc-content > ol {
        border-left: 2px solid #eee;
      }

      .left-toc-container .toc-item {
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
      }

      .left-toc-container .toc-link {
        color: var(--text-meta);
        text-decoration: none;
        transition: all 0.2s;
        display: block;
        padding: 2px 10px; /* 增加点击区域 */
        border-left: 2px solid transparent; /* 激活指示条 */
        margin-left: -12px; /* 修正位置以覆盖父级边框 */
      }

      .left-toc-container .toc-link:hover {
        color: var(--accent-color);
        background: rgba(0,0,0,0.02);
      }
      
      /* 激活状态样式 */
      .left-toc-container .toc-link.active {
        color: var(--accent-color);
        font-weight: bold;
        border-left-color: var(--accent-color); /* 绿色指示条 */
        background: linear-gradient(90deg, rgba(76,175,80,0.1) 0%, transparent 100%);
      }
      
      .left-toc-container .toc-child {
        display: none;
        padding-left: 10px;
      }
      
      .left-toc-container .toc-item.active > .toc-child {
        display: block;
      }
    </style>

    <script>
      // Scroll Spy Logic
      document.addEventListener('DOMContentLoaded', function() {
        var tocLinks = document.querySelectorAll('.left-toc-container .toc-link');
        var headers = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4');
        
        if (tocLinks.length > 0 && headers.length > 0) {
          var scrollSpy = function() {
            var fromTop = window.scrollY + 150; // Offset for header
            
            var currentHeader = null;
            headers.forEach(function(header) {
              if (header.offsetTop <= fromTop) {
                currentHeader = header;
              }
            });
            
            if (currentHeader) {
              var id = currentHeader.id || currentHeader.getAttribute('id');
              // Decode ID to handle Chinese characters
              try {
                id = decodeURIComponent(id);
              } catch(e) {}

              if(id) {
                 tocLinks.forEach(function(link) {
                   link.classList.remove('active');
                   link.parentElement.classList.remove('active');
                   
                   var href = decodeURIComponent(link.getAttribute('href')).substring(1);
                   if (href === id) {
                     link.classList.add('active');
                     link.parentElement.classList.add('active');
                     
                     // Auto scroll TOC container to keep active item in view
                     var container = document.querySelector('.left-toc-container');
                     var linkTop = link.offsetTop;
                     var containerHeight = container.offsetHeight;
                     var containerScroll = container.scrollTop;
                     
                     if (linkTop < containerScroll || linkTop > (containerScroll + containerHeight)) {
                       container.scrollTop = linkTop - containerHeight / 2;
                     }
                   }
                 });
              }
            }
          };
          
          window.addEventListener('scroll', scrollSpy);
          // Trigger once on load
          scrollSpy();
        }
      });
    </script>
  <% } %>

  <!-- Immersive Header (Hidden by default, shown in immersive mode) -->
  <!-- Removed immersive-header div since we use the main banner now -->

  <div class="post-content">
    <%- page.content %>
  </div>

  <% if (theme.reward && theme.reward.enable) { %>
    <div class="reward-container">
      <div class="reward-button" onclick="toggleReward()">
        <i class="fas fa-hand-holding-usd"></i> <%= theme.reward.title || '赞赏' %>
      </div>
      <div id="reward-qr" class="reward-qr">
        <div class="reward-message"><%= theme.reward.message %></div>
        <img src="<%= theme.reward.qrcode %>" alt="Reward QR">
      </div>
    </div>
    <script>
      function toggleReward() {
        var qr = document.getElementById('reward-qr');
        qr.classList.toggle('active');
      }
    </script>
  <% } %>

  <div class="post-footer">
    <!-- Footer content if needed, e.g. Share, Previous/Next -->
    
    <!-- Giscus Comments -->
    <div id="comments" style="margin-top: 50px;"></div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark_dimmed';
        var script = document.createElement('script');
        script.src = "https://giscus.app/client.js";
        script.setAttribute("data-repo", "Bayesianovich/Blog_comment");
        script.setAttribute("data-repo-id", "R_kgDOQ8Miig");
        script.setAttribute("data-category", "Announcements");
        script.setAttribute("data-category-id", "DIC_kwDOQ8Miis4C1G63");
        script.setAttribute("data-mapping", "pathname");
        script.setAttribute("data-strict", "0");
        script.setAttribute("data-reactions-enabled", "1");
        script.setAttribute("data-emit-metadata", "0");
        script.setAttribute("data-input-position", "bottom");
        script.setAttribute("data-theme", theme);
        script.setAttribute("data-lang", "zh-CN");
        script.setAttribute("crossorigin", "anonymous");
        script.async = true;
        document.getElementById('comments').appendChild(script);
      });
    </script>
  </div>
</article>

<script>
  function toggleImmersiveMode() {
    document.body.classList.toggle('immersive-mode');
    var btn = document.getElementById('immersive-toggle');
    var icon = btn.querySelector('i');
    
    if (document.body.classList.contains('immersive-mode')) {
      icon.classList.remove('fa-expand');
      icon.classList.add('fa-compress');
      btn.innerHTML = '<i class="fas fa-compress"></i> Exit Immersive';
    } else {
      icon.classList.remove('fa-compress');
      icon.classList.add('fa-expand');
      btn.innerHTML = '<i class="fas fa-expand"></i> Immersive Reading';
    }
  }
</script>